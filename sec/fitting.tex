\section{Calibration}
In order to tailor hand model for a specific user, we acquire a set of depth maps of multiple hand poses and attempt to fit a single convolution model through this data. 




% The first reason is that we want ensure that the resulting hand model will be able to assume all the poses that a real hand can, or at least the subset of poses for which we have the point clouds.
% The second reason is that the artifacts present in some input point clouds might be compensated by the others, so it is possible to accumulate information this way.
% For fitting we use the same optimization framework as for tracking (in a hope to extend it to fitting \& tracking real time system).
The main difference is that instead of the joint angles $\theta$, the hand model is parametrized by convolution surface centers locations and radii $[c , r]$. 

\textbf{Input}
\begin{itemize}
\item Sensor depth sequence 
\item A set of frame indices with different poses $i_1, ... i_n$
\item A template convolution hand model $[\tilde{c} ,\tilde{r}]$ 
\item Template initial rotations $\{\tilde{I}_1, ..., \tilde{I}_{15}\}$
\end{itemize}

\textbf{Output}
\begin{itemize}
\item A set of fitted convolution hand models $\{[c_1 , r]$, ..., $[c_n , r]\}$
\item  User-specific initial transformations $\{I_1, ... I_{15}\}$
\end{itemize}

\paragraph{Initialization}
The initial values of the parameters for each pose  $\{[c^0_1 , r^0]$, ..., $[c^0_n, r^0]\}$ are found tracking an input depth sequence with a template hand model globally scaled such that the length of the model hand matches the data (otherwise the tracking quality degrades). The initial values of the rotations  $\{I^0_1, ..., I^0_{15}\}$ coincide with the template rotations.

\subsection{Optimization}

We use the same set of variables for the radii of each posed model, this let us denote the parameters as $\sigma = \{c_1, ... c_n, r\}$ 

\vspace{-5mm}

\begin{equation*}
\sigma =\underset{\sigma}{\operatorname{argmin}} \; E_\text{data-model} + E_\text{model-data} + E_\text{consistency} + E_\text{existence} + E_\text{sync-rotations}
\end{equation*}

\subsubsection{Data-model energy}
The data-model energy is computed in exactly the same way as in Htrack, except that the gradients are much more complicated.
\Anastasia{We should put correspondences computation from tracking to fitting section, because it is used in fitting as well}
\begin{equation*}
E_\text{data-model} = \underset{p\in P}\sum \| p - q(\sigma)\|_2
\end{equation*}

\subsubsection{Model-data energy}
The first attempt was to make the model-data energy also the same as in Htrack. But probably due to more non-linear gradients that expression was giving unstable optimization, because it was involving a projection operator. So, the model-data energy is replaced by a similar energy, but in 3D space. \Anastasia{Maybe we could just say that it is exactly the same?}.
The model-data correspondences are also computed by rendering the model and the data, identifying the model points that are outside of the data silhouette and finding the closest data points in 2D using a distance transform. Afterwards for each 2D correspondence pair $\{m_{2D}, p_{2D}$\}, the original 3D points $\{m, p\}$ are looked up. We minimize the distance between $m$ and $p$ in the direction orthogonal to the camera ray that goes through $p$.

% \input{fig/optimization/item}
% \begin{equation*}
% E_\text{model-data} = \underset{m\in M}\sum n^T(p - m(\sigma))
% \end{equation*}

\Anastasia{I was using another version of model-data energy for photoscan ``all around'' point cloud, which was exactly symmetrical to data-model energy. The model points were generated by sampling the model surface, and the corresponding data points were found using a kd-tree.}

\subsection{Optimization}
The consistency energy requires that for every rigid part of the skeleton the distances between every pair of vertices are the same for all the poses. The consistency energy does not apply to elastic parts of hand model.
\Anastasia{To demonstrate rigid parts I could color-code them on the skeleton topology image. The rigid parts are palm, wrist and each finger segment}

\subsection{Existence energy}
This energy ensures that pills do not degenerate into spheres and wedges do not degenerate into pills.
A pill becomes degenerate if one of the spheres is completely inside of another sphere. A wedge becomes degenerate if a sphere is completely inside of the tangent cone of two other spheres. The energy switches on if a pill or a wedge is within a threshold of becoming degenerate and pushes the optimization away.

\subsection{Synchronizing rotations energy}
This energy ensures that initial rotations are similar for all the poses. The common initial rotations are computed as described in the section ``Initial Rotations``. The energy minimizes the distance between the current centers and the centers locations with common initial rotations. 
This energy is very important, because it constraints fingers motion in meaningful way. In the absence of this energy each joint bends in arbitrary direction.
